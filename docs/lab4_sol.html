<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Bradley Katcher">

<title>R Lab 4 Solutions – R Math Camp</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-a14e3238c51140e99ccc48519b6ed9ce.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">R Lab 4 Solutions</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Bradley Katcher </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>I am grateful to Professor Dan Levy and previous API-209 TAs for the creation of this portion of the problem set.</p>
<section id="question-2-learning-about-rwandas-economy" class="level1">
<h1>QUESTION 2 – LEARNING ABOUT RWANDA’S ECONOMY</h1>
<section id="guidance-on-solving-r-questions" class="level3">
<h3 class="anchored" data-anchor-id="guidance-on-solving-r-questions">GUIDANCE ON SOLVING R QUESTIONS</h3>
<p>In most API-209 problem sets, you will encounter questions designed to help you acquire R coding skills. As you saw in the first day of classes, there are some people in your class that have extensive coding experience and others who are new to coding. Regardless of where you stand, here are a few tips to solve R questions:&nbsp;</p>
<ul>
<li><p>In every problem set, you will need to <strong>set up your environment</strong>:&nbsp;</p>
<ul>
<li>You should create a subdirectory for Problem Set 1 and keep all your data, code, and work in that directory. You may also want to make an RStudio Project specifically for that project directory&nbsp;</li>
</ul></li>
<li><p>There are high chances that <strong>you will get stuck with your code at some point</strong>; <strong>this is a very natural part of coding!</strong> Knowing how to troubleshoot becomes a key skill:&nbsp;</p>
<ul>
<li><p>Google and AI tools like ChatGPT are extremely useful resources when you don’t know the command or code needed to solve a problem. We encourage you to leverage them on your learning process. However, our advice is that you refer to AI only after having tried to figure out how to do it by yourself as this will better allow you to develop your R skills&nbsp;</p></li>
<li><p>If you have not found the answers online, ask your CAs or classmates for help! It is very easy to get stuck on a problem for hours, even if it can be very quickly solved with guidance from a person knowledgeable in R</p></li>
</ul></li>
<li><p>In some instances, <strong>we will ask you to create graphs or tables</strong>:&nbsp;</p>
<ul>
<li><p>If we ask you to replicate them from an existing source, we expect you to produce something professional-looking and similar to the original work; but it does not need to match 100% of its elements&nbsp;</p></li>
<li><p>If you create your own visualization from scratch, we encourage you to adjust it to improve readability and professional appearance, even if we do not explicitly request it. However, you should not feel the pressure to do this if you are just getting started with R</p></li>
</ul></li>
</ul>
</section>
<section id="introducing-the-final-exercise" class="level3">
<h3 class="anchored" data-anchor-id="introducing-the-final-exercise">INTRODUCING THE FINAL EXERCISE</h3>
<p>This question serves <strong>two purposes</strong>: (i) getting you familiarized with some of the data you will use in the API - 209 and DEV - 401 final exercise and (ii) developing your R skills to analyze data.&nbsp;</p>
<p>The <strong>objective of the final exercise is to give you an opportunity to apply the analytic tools you will acquire in API-209 and DEV-401 to a real policy setting</strong>. You will have R exercises in problem sets that will introduce you to the challenges you will be working on, help you get a head start in your project, and increase your chances of producing a final output you are proud of.</p>
</section>
<section id="q2-part-1-understanding-rwandas-economy" class="level3">
<h3 class="anchored" data-anchor-id="q2-part-1-understanding-rwandas-economy">Q2 PART 1: UNDERSTANDING RWANDA’S ECONOMY</h3>
<p>The dataset for this question is an extract from World Bank’s World Development Indicators (WDI). Please download the dataset “PS1_dataset1.csv” from our Canvas website. First, familiarize yourself with the dataset. Then import it into R and answer the questions below. We will start by focusing on the gross domestic product (GDP), a concept you dealt with in your Macro class with Prof.&nbsp;Frankel. The WDI dataset reports GDP values in 2015 U.S. dollars, so you can directly compare values in different years.&nbsp;</p>
<p><strong>(A) Explore the data set:</strong> An essential practice before doing any data analysis is to explore the data set. Here are some questions to ask:</p>
<ul>
<li>What is the unit of observation (i.e.&nbsp;country, year, country/year, etc.)?</li>
<li>How many observations are in the data set?</li>
<li>What are the key variables in the data set?</li>
<li>For the key variables, how are they coded, what is the extent of missing data for key variables, and how will I deal with this missing data?</li>
</ul>
<p>Once you have done this (no need to type answers to these questions, but do answer them), create an analysis data set in which:</p>
<ul>
<li>You keep only observations that have non-missing data for both GDP_1995 and GDP_2022. This will be the data set you will you for the remainder of this problem set, so assign it to an object you can use.</li>
<li>You transform the population variables so that they are expressed in millions of people (for example, 158,000,000 should become 158).</li>
<li>You transform the GDP variables so that they are expressed in millions of dollars&nbsp;&nbsp;</li>
</ul>
<p>This will be the data set you will you for the remainder of this problem set, so assign it to an object you can use. Now report the mean and the number of observations for GDP 2022 for this analysis data set.&nbsp;</p>
<div class="answer-box">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre class="bg-warning"><code># A tibble: 173 × 7
   Country  `Country Code` Region GDP_1995 GDP_2022 POP_1995
   &lt;chr&gt;    &lt;chr&gt;          &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 Albania  ALB            Europ…    4743.   14318.   3.19  
 2 Algeria  DZA            Middl…   81507.  179000   28.5   
 3 Andorra  AND            Europ…    1765.    3149.   0.0629
 4 Angola   AGO            Sub-S…   22469.   81810.  13.9   
 5 Antigua… ATG            Latin…     825.    1546.   0.0684
 6 Argenti… ARG            Latin…  348000   598000   34.9   
 7 Armenia  ARM            Europ…    3084.   14212.   3.32  
 8 Austral… AUS            East …  709000  1580000   18.0   
 9 Austria  AUT            Europ…  269000   425000    7.95  
10 Azerbai… AZE            Europ…    8473.   56692.   7.68  
# ℹ 163 more rows
# ℹ 1 more variable: POP_2022 &lt;dbl&gt;</code></pre>
</div>
</div>
</div>
<hr>
<p><strong>(B) Understanding Rwanda’s economic evolution:</strong> we will start by understand how Rwanda’s economy has evolved over time:</p>
<p>(B1) Report Rwanda’s GDP in 2022.</p>
<div class="answer-box">
<p><strong>Answer:</strong> Rwanda’s GDP in 2022 was 1.2956^{4} million USD or $12.956 billion USD.</p>
</div>
<hr>
<p>(B2) Calculate the GDP per capita in 1995 and in 2022 for Rwanda. Save your results to a new object.</p>
<div class="answer-box">
<p><strong>Answer:</strong> See output above.</p>
</div>
<hr>
<p>(B3) Calculate the increase in GDP per capita in Rwanda from 1995 to 2022 (in % change)</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre class="bg-warning"><code># A tibble: 1 × 3
  gdp_pc_1995 gdp_pc_2022 perc_change
        &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
1        305.        940.        209.</code></pre>
</div>
</div>
<div class="answer-box">
<p><strong>Answer:</strong> See output above.</p>
</div>
<hr>
<p><strong>(C)</strong> <strong>Comparing Rwanda to other African countries:</strong></p>
<p>(C1) Calculate the GDP per capita in 1995 and in 2022 for each country in Sub-Saharan Africa. Report the average GPD per capita across Sub-Saharan Africa in 2022</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre class="bg-warning"><code>[1] 2388.862</code></pre>
</div>
</div>
<div class="answer-box">
<p><strong>Answer:</strong> The average GDP per capita across Sub-Saharan Africa in 2022 was 2388.8623609 million USD per person.</p>
</div>
<hr>
<p>(C2) Calculate the increase in GDP per capita for each country in Sub-Saharan Africa from 1995 to 2022 (in % change). Report the average increase in GPD per capita from 1995 to 2022 across Sub-Saharan Africa</p>
<div class="answer-box">
<p><strong>Answer:</strong> The average increase in GDP per capita from 1995 to 2022 across Sub-Saharan Africa was 55.4901874 million USD per person.</p>
</div>
<hr>
<p>(C3) Rank all the countries of Sub-Saharan Africa in descending order first in terms of GPD per capita in 2022 and then in terms of GDP per capita growth from 1995 to 2022 (in % change). Report:</p>
<ol type="i">
<li><p>in which place Rwanda ends up in each case</p></li>
<li><p>two to five countries that are in a similar position (in terms of GDP per capita in 2022 and growth from 1995 to</p>
<ol start="2022" type="1">
<li></li>
</ol></li>
</ol>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre class="bg-warning"><code># A tibble: 43 × 10
   Country  `Country Code` Region GDP_1995 GDP_2022 POP_1995
   &lt;chr&gt;    &lt;chr&gt;          &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 Seychel… SYC            Sub-S…     718.    1713.   0.0753
 2 Mauriti… MUS            Sub-S…    5121.   13314.   1.12  
 3 Botswana BWA            Sub-S…    6593.   17510.   1.54  
 4 Gabon    GAB            Sub-S…    9564.   15867.   1.12  
 5 South A… ZAF            Sub-S…  193000   360000   44.0   
 6 Equator… GNQ            Sub-S…     353.    9834.   0.561 
 7 Namibia  NAM            Sub-S…    4719.   11187.   1.61  
 8 Eswatini SWZ            Sub-S…    2159.    4861.   0.954 
 9 Cabo Ve… CPV            Sub-S…     522.    2161.   0.411 
10 Nigeria  NGA            Sub-S…  155000   535000  108.    
# ℹ 33 more rows
# ℹ 4 more variables: POP_2022 &lt;dbl&gt;, gdp_pc_1995 &lt;dbl&gt;,
#   gdp_pc_2022 &lt;dbl&gt;, perc_change &lt;dbl&gt;</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre class="bg-warning"><code># A tibble: 43 × 10
   Country  `Country Code` Region GDP_1995 GDP_2022 POP_1995
   &lt;chr&gt;    &lt;chr&gt;          &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 Equator… GNQ            Sub-S…     353.    9834.    0.561
 2 Ethiopia ETH            Sub-S…   13897.  106000    57.5  
 3 Rwanda   RWA            Sub-S…    1733.   12956.    5.69 
 4 Cabo Ve… CPV            Sub-S…     522.    2161.    0.411
 5 Mozambi… MOZ            Sub-S…    3394.   19146.   15.6  
 6 Mauriti… MUS            Sub-S…    5121.   13314.    1.12 
 7 Ghana    GHA            Sub-S…   16239.   68292.   17.4  
 8 Uganda   UGA            Sub-S…    9118.   44173.   20.7  
 9 Tanzania TZA            Sub-S…   15016.   67104.   30.6  
10 Burkina… BFA            Sub-S…    3686.   16589.   10.4  
# ℹ 33 more rows
# ℹ 4 more variables: POP_2022 &lt;dbl&gt;, gdp_pc_1995 &lt;dbl&gt;,
#   gdp_pc_2022 &lt;dbl&gt;, perc_change &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="answer-box">
<p><strong>Answer:</strong> Rwanda had the 27th highest GDP per capita in 2022 but grew more since 1995 than all but two countries in the region. Countries in a similar position on both dimensions include Ethiopia, Uganda, and Tanzania.</p>
</div>
<hr>
<p>(C4) Draw a histogram showing the distribution of GDP per capita in 2022 for countries in Sub-Saharan Africa, using bins that are $1,000 wide. Imagine this histogram were to appear in The Economist, i.e., make it well-labeled and professionally looking. Feel free to tweet it using #api209 or post it on our #r-tips Slack channel.&nbsp;</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab4_sol_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>(D) Putting it all together:</strong> in one crisp paragraph (2-3 sentences), summarize your findings from your analyses in (a)-(c)&nbsp;</p>
<hr>
<div class="answer-box">
<p><strong>Answer:</strong> Answers may vary. Responses could mention Rwanda’s GDP in 2022 and its change since 1995, as well as how it stacks up against the rest of the region alongside some similar neighbors.</p>
</div>
<hr>
</section>
<section id="q2-part-2-understanding-rwandas-exports" class="level3">
<h3 class="anchored" data-anchor-id="q2-part-2-understanding-rwandas-exports">Q2 PART 2: UNDERSTANDING RWANDA’S EXPORTS</h3>
<p>The dataset for this question is an extract from the Atlas of Economic Complexity. Please download the dataset “PS1_dataset2.csv” from our Canvas website. The dataset includes one single tab with the data extract that you will use for this question, containing data on Rwanda’s export per sector from 1995 to 2021. First, familiarize yourself with the worksheet then import these data into R and explore the dataset. You do not need to share your answer here, but we recommend you to use question (a) above as guidance. Once you have explored the dataset, please proceed with the rest of the questions.&nbsp;</p>
<p><strong>(E) Understanding the evolution of Rwanda’s exports:</strong> produce a table summarizing the evolution of exports per sector. Each sector (e.g., agriculture, services, etc.) should be a row in your table, with each year representing a column. To make it easier to digest, (i) aggregate the different sectors into four buckets: agriculture, manufacturing - include chemicals, electronics, machinery, textiles, vehicles and other -, mining and metals – include metals, minerals, and stone -, and services (ii) show only exports for years 1995, 2005, 2015 and 2021.&nbsp;</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre class="bg-warning"><code>[1] 0.2050781</code></pre>
</div>
</div>
<p><strong>(F) Interpret your findings:</strong> what insights and patterns do you observe from your analysis in (e)?</p>
<hr>
<div class="answer-box">
<p><strong>Answer:</strong> It seems as through agriculture has always been an important part of the Rwandan economy, but has more recently been ecplipsed by the manufacturing sector. Services decreased between 2015 and 2021, while other sectors increased significantly since 2005, becoming even more valuable than the agriculture sector.</p>
</div>
<hr>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/bradleykatcher\.github\.io\/r-mathcamp");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>